## Integrating with Amazon Rekognition: Automating Photo Evaluation for the Cloudtopia Passport Office Automation Project

![Rekognition](/assets/ct-rekognition.png)

To enhance the photo evaluation workflow, I will use the Amazon Rekognition DetectFaces API. This API allows you to analyze images stored in S3, providing detailed assessments of various facial features.

When a file is uploaded to the S3 bucket, the DetectFaces API will be triggered. The API retrieves the image from S3 and evaluates it for a variety of facial features, including gender, age, smiling, sunglasses, and more. Each feature is tagged with an evaluation result (true/false) and a confidence value ranging from 0 to 100, which conveys the confidence Rekognition has in its evaluation decision. As developers, we need to decide on a confidence threshold that will serve as our criterion for success when assessing these evaluation results.

As you proceed through the following steps, you'll see how the DetectFaces API seamlessly integrates with S3 and Lambda functions to automate and enhance the passport photo validation process.

### Step 1: Attach IAM Policy Rekognition:DetectFaces to PhotoValidationProcessor

![Rekognition Add Policy](/assets/rekognition-permissions.png)

* Under the `Function overview` go to `Configuration`
* Click `Permissions`
* Click the link under `Role name` which opens the IAM Role page

![Rekognition Add Policy](/assets/inline-again.png)

* Scroll down and click `Add permissions` then click on `Create inline policy`
* On the next page, click the `Specify permissions` dropdown and enter `Rekognition`
* Click on `Read` and select `DetectFaces`
* Click `Next`

![Detect Faces Policy](/assets/detect-faces.png)

* Name your policy in the `Policy name` box
* Click `Create policy`

![Policy Name](/assets/Rekognition-policy-name.png)

You will now see that the Rekognition permission is added back on the Lambda function page under the overview in the `Permissions` tab.

![Permissions Added Rekognition](/assets/rekognition-permission-added.png)

### Step 2: Extract filename from S3 PUT Event

* Underneath the `Function overview` click on the `Code` tab
* Input code:

```py
import json
import boto3
import uuid
import datetime

BUCKET_NAME = "cloudtopia-images-jun-2024" 
FACE_DETAILS_THRESHOLDS = {"Smile": {"desiredValue": False, "minConfidence": 90}, "Sunglasses": {"desiredValue": False, "minConfidence": 90}, "EyesOpen": {"desiredValue": True, "minConfidence": 90}, "MouthOpen": {"desiredValue": False, "minConfidence": 90}}

rekognition_client = boto3.client('rekognition')

def lambda_handler(event, context):
    
    #Step 1 - Extract File Name from PUT Event
    current_file_name = extract_file_name(event)
    print(current_file_name)
    
    #Step 2 - Call Rekognition DetectFaces API
    detect_faces_response = detect_faces(current_file_name)
```
* Create a test event by clicking the down arrow next to `Test`
* Then click `Configure test event`

![Test Event & Code](/assets/test-event.png)

* In `Event name` put S3
* Click on `Template`
* Type in S3
* Click `S3 PUT`

![S3 PUT](/assets/s3-test-event.png)





